{% extends "base.html" %}

{% block title %}Manage Sale Locations - FS25 Farm Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-map-marker-alt"></i> Manage Sale Locations</h1>
    <div class="d-flex gap-2">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addLocationModal">
            <i class="fas fa-plus"></i> Add Location
        </button>
        <form method="POST" action="{{ url_for('bulk_add_locations') }}" style="display: inline;">
            <button type="submit" class="btn btn-outline-success">
                <i class="fas fa-download"></i> Add Defaults
            </button>
        </form>
        <a href="{{ url_for('storage_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Storage
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-number">{{ locations|length }}</div>
                <div class="stats-label">Total Locations</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-number">{{ locations|selectattr('in_use')|list|length }}</div>
                <div class="stats-label">In Use</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-number">{{ locations|rejectattr('in_use')|list|length }}</div>
                <div class="stats-label">Available</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-number">{{ locations|selectattr('location_type')|groupby('location_type')|list|length }}</div>
                <div class="stats-label">Location Types</div>
            </div>
        </div>
    </div>
</div>

<!-- Locations Table -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Sale Locations</h5>
    </div>
    <div class="card-body">
        {% if locations %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Location Name</th>
                        <th>Type</th>
                        <th>Distance</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for location in locations %}
                    <tr>
                        <td>
                            <strong>{{ location.location_name }}</strong>
                            {% if location.notes %}
                            <br><small class="text-muted">{{ location.notes }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ location.location_type or 'Unknown' }}</span>
                        </td>
                        <td>
                            {% if location.distance_km %}
                                {{ location.distance_km }} km
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if location.contact_info %}
                                {{ location.contact_info }}
                            {% else %}
                                <span class="text-muted">No contact info</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if location.in_use %}
                                <span class="badge bg-success">In Use</span>
                            {% else %}
                                <span class="badge bg-secondary">Available</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if location.location_id %}
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="editLocation({{ location.location_id }}, '{{ location.location_name }}', '{{ location.location_type or '' }}', {{ location.distance_km or 'null' }}, '{{ location.contact_info or '' }}', '{{ location.notes or '' }}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                {% if not location.in_use %}
                                <form method="POST" action="{{ url_for('delete_location', location_id=location.location_id) }}" 
                                      style="display: inline;" onsubmit="return confirm('Delete this location?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                                {% endif %}
                                {% else %}
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="saveLocation('{{ location.location_name }}')">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
            <h4>No Sale Locations</h4>
            <p class="text-muted">Add your first sale location to get started.</p>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addLocationModal">
                <i class="fas fa-plus"></i> Add First Location
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Location Modal -->
<div class="modal fade" id="addLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Sale Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_location') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="location_name" class="form-label">Location Name *</label>
                        <input type="text" class="form-control" id="location_name" name="location_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="location_type" class="form-label">Location Type</label>
                        <select class="form-select" id="location_type" name="location_type">
                            <option value="">Select type</option>
                            <option value="Elevator">Elevator</option>
                            <option value="Terminal">Terminal</option>
                            <option value="Mill">Mill</option>
                            <option value="Processing">Processing Plant</option>
                            <option value="Factory">Factory</option>
                            <option value="Market">Market</option>
                            <option value="Farm">Farm</option>
                            <option value="Plant">Plant</option>
                            <option value="Retail">Retail</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="distance_km" class="form-label">Distance (km)</label>
                        <input type="number" step="0.1" class="form-control" id="distance_km" name="distance_km">
                    </div>
                    <div class="mb-3">
                        <label for="contact_info" class="form-label">Contact Information</label>
                        <input type="text" class="form-control" id="contact_info" name="contact_info" 
                               placeholder="Phone, email, or company name">
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Location</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Location Modal -->
<div class="modal fade" id="editLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Sale Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editLocationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_location_name" class="form-label">Location Name *</label>
                        <input type="text" class="form-control" id="edit_location_name" name="location_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_location_type" class="form-label">Location Type</label>
                        <select class="form-select" id="edit_location_type" name="location_type">
                            <option value="">Select type</option>
                            <option value="Elevator">Elevator</option>
                            <option value="Terminal">Terminal</option>
                            <option value="Mill">Mill</option>
                            <option value="Processing">Processing Plant</option>
                            <option value="Factory">Factory</option>
                            <option value="Market">Market</option>
                            <option value="Farm">Farm</option>
                            <option value="Plant">Plant</option>
                            <option value="Retail">Retail</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_distance_km" class="form-label">Distance (km)</label>
                        <input type="number" step="0.1" class="form-control" id="edit_distance_km" name="distance_km">
                    </div>
                    <div class="mb-3">
                        <label for="edit_contact_info" class="form-label">Contact Information</label>
                        <input type="text" class="form-control" id="edit_contact_info" name="contact_info">
                    </div>
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Location</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editLocation(locationId, name, type, distance, contact, notes) {
    document.getElementById('edit_location_name').value = name;
    document.getElementById('edit_location_type').value = type;
    document.getElementById('edit_distance_km').value = distance;
    document.getElementById('edit_contact_info').value = contact;
    document.getElementById('edit_notes').value = notes;
    
    const form = document.getElementById('editLocationForm');
    form.action = '/storage/locations/' + locationId + '/edit';
    
    const modal = new bootstrap.Modal(document.getElementById('editLocationModal'));
    modal.show();
}

function saveLocation(locationName) {
    // For locations that are used but not saved, add them to the database
    document.getElementById('location_name').value = locationName;
    const modal = new bootstrap.Modal(document.getElementById('addLocationModal'));
    modal.show();
}
</script>
{% endblock %}